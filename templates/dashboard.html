{% extends "layout.html" %}

{% block content %}
<div class="dashboard-header">
    <div class="header-title">
        <h1>Dashboard</h1>
        <p>Overview of Warranty Claims</p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('dashboard', refresh='true') }}" class="date-display"
            style="text-decoration: none; margin-right: 1rem; cursor: pointer; color: var(--primary);">
            <i class="ri-refresh-line" style="margin-right: 4px;"></i> Refresh Data
        </a>
        <span class="current-date" id="currentDate"></span>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card glass-panel" onclick="filterClaims('all')" style="cursor: pointer;">
        <div class="icon-box blue"><i class="ri-file-list-3-line"></i></div>
        <div class="stat-info">
            <h3>Total Claims</h3>
            <span class="number">{{ total }}</span>
        </div>
    </div>
    <div class="stat-card glass-panel" onclick="filterClaims('pending')" style="cursor: pointer;">
        <div class="icon-box orange"><i class="ri-time-line"></i></div>
        <div class="stat-info">
            <h3>Pending</h3>
            <span class="number">{{ pending }}</span>
        </div>
    </div>
    <div class="stat-card glass-panel" onclick="filterClaims('completed')" style="cursor: pointer;">
        <div class="icon-box green"><i class="ri-checkbox-circle-line"></i></div>
        <div class="stat-info">
            <h3>Completed</h3>
            <span class="number">{{ completed }}</span>
        </div>
    </div>
    <div class="stat-card glass-panel">
        <div class="icon-box purple" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;"><i
                class="ri-timer-flash-line"></i></div>
        <div class="stat-info">
            <h3>Avg TAT</h3>
            <span class="number">{{ avg_tat }} <span
                    style="font-size: 0.9rem; color: #6b7280; font-weight: 500;">Days</span></span>
        </div>
    </div>
</div>

<!-- Claims Table -->
<div class="glass-panel table-container">
    <div class="table-header">
        <h2>Recent Claims</h2>
        <div class="search-box">
            <i class="ri-search-line"></i>
            <input type="text" id="searchInput" placeholder="Search claims..." onkeyup="filterTable()">
        </div>
    </div>
    <div class="table-responsive">
        <table class="premium-table">
            <thead>
                <tr>
                    <th>Claim ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="claimsTableBody">
                {% for claim in claims %}
                <tr data-completed="{{ 'true' if claim.complete else 'false' }}">
                    <td>
                        <span class="id-badge clickable" onclick="openClaimModal('{{ claim.claim_id }}')"
                            style="cursor: pointer; color: var(--primary); font-weight: 600;">
                            {{ claim.claim_id }}
                        </span>
                    </td>
                    <td>{{ claim.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <div class="customer-cell">
                            <span class="name">{{ claim.customer_name }}</span>
                            <span class="sub">{{ claim.mobile_no }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-pill {{ claim.status|lower|replace(' ', '-') }}">
                            {{ claim.status }}
                        </span>
                    <td>
                        <button class="btn-icon" onclick="openClaimEditModal('{{ claim.claim_id }}')">
                            <i class="ri-edit-2-line"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Details Modal Template (Hidden, populated by JS) -->
<template id="claimDetailTemplate">
    <div class="claim-detail-view">
        <div class="detail-header">
            <h2 id="modalTitle">Claim Details</h2>
        </div>

        <div id="tab-info" class="tab-content active">
            <div id="tab-info" class="tab-content active">
                <!-- Premium Details Grid -->
                <div class="detail-grid-premium">
                    <!-- Row 1 -->
                    <div class="detail-item">
                        <span class="detail-label">Claim ID</span>
                        <span class="detail-value" id="disp_claimId">CLM-12345678</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value" id="disp_status">Replacement approved</span>
                    </div>

                    <!-- Row 2 -->
                    <div class="detail-item">
                        <span class="detail-label">Customer Name</span>
                        <span class="detail-value" id="disp_name">SHANTHAMMA A</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Mobile Number</span>
                        <span class="detail-value" id="disp_mobile">9446454842</span>
                    </div>

                    <!-- Row 3 -->
                    <div class="detail-item">
                        <span class="detail-label">Product</span>
                        <span class="detail-value" id="disp_product">GDOT XR32 XOR SERIES NORMAL LED TV</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Submitted Date</span>
                        <span class="detail-value" id="disp_date">21 Dec 2025</span>
                    </div>

                    <!-- Row 4 -->
                    <div class="detail-item">
                        <span class="detail-label">OSID</span>
                        <span class="detail-value" id="disp_osid">3F20000016451365</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Invoice Number</span>
                        <span class="detail-value" id="disp_invoice">24-S-TPVD-9352</span>
                    </div>

                    <!-- Row 5 -->
                    <div class="detail-item">
                        <span class="detail-label">SR Number</span>
                        <span class="detail-value" id="disp_srno">251017-001548</span>
                    </div>
                    <div class="detail-item"></div>
                </div>

                <!-- Issue Description -->
                <div class="detail-item">
                    <span class="detail-label">Issue Description</span>
                    <div class="issue-box" id="disp_issue">
                        Sound is not working
                    </div>
                </div>

                <div class="divider" style="height: 1px; background: #e5e7eb; margin: 2rem 0 1rem 0;"></div>

                <!-- Workflow Status Section -->
                <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem;">
                    Workflow Status</h3>

                <div class="workflow-status-list" id="workflowStatusList">
                    <!-- Dynamic Content -->
                </div>

                <div class="divider" style="height: 1px; background: #e5e7eb; margin: 2rem 0 1rem 0;"></div>

                <!-- Follow Up Section (Collapsible) -->
                <div class="follow-up-section" style="margin-bottom: 2rem;">
                    <div class="field-group" id="wf-section-followup">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span class="detail-label">Follow Up Actions</span>
                            <button type="button" class="btn-refresh" onclick="toggleFollowUpHistory()"
                                style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                <i class="ri-history-line"></i> View History
                            </button>
                        </div>
                        <textarea id="followUpHistory" rows="5" readonly class="read-only-field hidden"
                            style="margin-bottom: 1rem;"></textarea>

                    </div>
                </div>
            </div>
        </div>

    </div>

    </div>

    <div id="tab-workflow" class="tab-content">
        <div class="checkbox-list">
            <div id="wf-section-repair">
                <h4>Repair Completed</h4>
                <label class="custom-checkbox">
                    <input type="checkbox" id="chk_repair_feedback">
                    <span class="checkmark"></span>
                    Feedback Done
                </label>
                <div class="workflow-row">
                    <label class="custom-checkbox">
                        <input type="checkbox" id="chk_complete_repair">
                        <span class="checkmark"></span>
                        <strong>Mark as Complete</strong>
                    </label>
                </div>
            </div>

            <!-- Enhanced Workflow Section -->
            <div class="workflow-section" id="workflow-replacement-section">
                <!-- Header with Progress -->
                <div class="workflow-header">
                    <div class="workflow-title">
                        <i class="ri-exchange-line"></i>
                        Replacement Workflow
                    </div>
                    <div class="workflow-progress">
                        <span class="progress-text" id="workflow-progress-text">0 of 6 completed</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="workflow-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Steps -->
                <div class="workflow-steps">
                    <!-- Step 1: Customer Confirmation -->
                    <div class="workflow-step" data-step-number="1"
                        onclick="toggleWorkflowStep(this, 'chk_repl_confirmation')">
                        <div class="step-icon" data-step="1"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">Customer Confirmation</div>
                                <div class="step-description">Customer has confirmed replacement request</div>
                            </div>
                            <input type="checkbox" id="chk_repl_confirmation" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>

                    <!-- Step 2: OSG Approval -->
                    <div class="workflow-step" data-step-number="2"
                        onclick="toggleWorkflowStep(this, 'chk_repl_osg_approval')">
                        <div class="step-icon" data-step="2"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">OSG Approval</div>
                                <div class="step-description">Received approval from Onsitego</div>
                            </div>
                            <input type="checkbox" id="chk_repl_osg_approval" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>

                    <!-- Step 3: Mail to Store -->
                    <div class="workflow-step" data-step-number="3"
                        onclick="toggleWorkflowStep(this, 'chk_repl_mail_store')">
                        <div class="step-icon" data-step="3"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">Mail Sent To Store</div>
                                <div class="step-description">Replacement request sent to store</div>
                            </div>
                            <input type="checkbox" id="chk_repl_mail_store" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>

                    <!-- Step 4: Invoice Generated -->
                    <div class="workflow-step" data-step-number="4"
                        onclick="toggleWorkflowStep(this, 'chk_repl_invoice_gen')">
                        <div class="step-icon" data-step="4"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">Invoice Generated</div>
                                <div class="step-description">Replacement invoice has been created</div>
                            </div>
                            <input type="checkbox" id="chk_repl_invoice_gen" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>

                    <!-- Step 5: Invoice Sent -->
                    <div class="workflow-step" data-step-number="5"
                        onclick="toggleWorkflowStep(this, 'chk_repl_invoice_sent')">
                        <div class="step-icon" data-step="5"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">Invoice Sent To Onsitego</div>
                                <div class="step-description">Invoice submitted to Onsitego for payment</div>
                            </div>
                            <input type="checkbox" id="chk_repl_invoice_sent" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>

                    <!-- Step 6: Settled with Accounts -->
                    <div class="workflow-step" data-step-number="6"
                        onclick="toggleWorkflowStep(this, 'chk_repl_settled_accounts')">
                        <div class="step-icon" data-step="6"></div>
                        <div class="step-content">
                            <div class="step-info">
                                <div class="step-label">Settled With Accounts</div>
                                <div class="step-description">Payment received and settled</div>
                            </div>
                            <input type="checkbox" id="chk_repl_settled_accounts" class="step-checkbox"
                                onclick="event.stopPropagation(); updateWorkflowProgress()">
                        </div>
                    </div>
                </div>

                <!-- Completion Badge -->
                <div class="completion-badge incomplete" id="workflow-completion-badge">
                    <i class="ri-time-line"></i>
                    <span id="completion-badge-text">Workflow In Progress</span>
                </div>

                <!-- Mark as Complete Checkbox -->
                <div class="workflow-step" style="margin-top: 20px;"
                    onclick="toggleWorkflowStep(this, 'chk_complete_repl')">
                    <div class="step-icon" data-step="âœ“"
                        style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);"></div>
                    <div class="step-content">
                        <div class="step-info">
                            <div class="step-label" style="font-size: 1.1rem;"><strong>Mark as Complete</strong>
                            </div>
                            <div class="step-description">Claim has been fully processed and closed</div>
                        </div>
                        <input type="checkbox" id="chk_complete_repl" class="step-checkbox"
                            onclick="event.stopPropagation(); updateCompletionStatus()">
                    </div>
                </div>

            </div>
        </div>

        <!-- Follow Up Section (Sibling, not nested) -->
        <div id="wf-section-followup" class="hidden" style="margin-top: 20px;">
            <div class="workflow-title" style="margin-bottom: 20px;">Workflow Status: Follow Up</div>

            <div class="field-group">
                <label>Follow Up Date</label>
                <input type="date" id="followUpDate">
            </div>
            <div class="field-group">
                <label>History</label>
                <textarea id="followUpHistory" rows="6" readonly class="read-only-field"></textarea>
            </div>
            <div class="field-group">
                <label>Add New Note</label>
                <textarea id="newFollowUpNote" rows="3" placeholder="Enter new follow up details here..."></textarea>
            </div>
        </div>
    </div>
    </div>

    <div class="modal-footer">
        <button id="btn-save-changes" class="btn-primary" onclick="saveClaimChanges()">Save Changes</button>
    </div>
    </div>
</template>

</template>

<!-- Editor Modal Template (Populated by JS for Action button) -->
<template id="claimEditTemplate">
    <div class="claim-detail-view">
        <div class="detail-header">
            <h2 id="modalTitle">Edit Claim</h2>
            <div class="status-select-wrapper">
                <select id="updateStatus" class="status-select">
                    <option value="Submitted">Submitted</option>
                    <option value="Registered">Registered</option>
                    <option value="Follow Up">Follow Up</option>
                    <option value="Repair Completed">Repair Completed</option>
                    <option value="Replacement approved">Replacement Approved</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="btn-tab-info" onclick="switchTab('info')">Info</button>
            <button class="tab-btn" id="btn-tab-workflow" onclick="switchTab('workflow')">Workflow</button>
        </div>

        <div id="tab-info" class="tab-content active">
            <!-- Editable Details Grid -->
            <div class="details-grid"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <div class="field-group">
                    <label>Customer Name</label>
                    <input type="text" id="detailName" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>Mobile Number</label>
                    <input type="text" id="detailMobile" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>Address</label>
                    <input type="text" id="detailAddress" readonly class="read-only-field">
                </div>

                <div class="field-group">
                    <label>Model</label>
                    <input type="text" id="detailModel" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>Serial Number</label>
                    <input type="text" id="detailSerial" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>Invoice Number</label>
                    <input type="text" id="detailInvoice" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>OSID</label>
                    <input type="text" id="claimOsid" readonly class="read-only-field">
                </div>
                <div class="field-group">
                    <label>SR Number</label>
                    <input type="text" id="claimSrNo" placeholder="Enter SR No">
                </div>
                <div class="field-group">
                    <label>Submitted Date</label>
                    <input type="text" id="submittedDate" readonly class="read-only-field">
                </div>
                <div class="field-group" style="grid-column: span 2;">
                    <label>Issue Description</label>
                    <textarea id="detailIssue" rows="2" readonly class="read-only-field"></textarea>
                </div>
            </div>

            <div class="divider" style="height: 1px; background: #e5e7eb; margin: 1rem 0 2rem 0;"></div>

            <!-- Follow Up Section -->
            <div class="follow-up-section" style="margin-bottom: 2rem;">
                <div class="field-group" id="wf-section-followup">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin-bottom: 0;">Follow Up History</label>
                        <button type="button" class="btn-refresh" onclick="toggleFollowUpHistory()"
                            style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                            <i class="ri-history-line"></i> View History
                        </button>
                    </div>
                    <textarea id="followUpHistory" rows="5" readonly class="read-only-field hidden"
                        style="margin-bottom: 1rem;"></textarea>

                    <label>Add New Note</label>
                    <textarea id="newFollowUpNote" rows="2" placeholder="Enter interaction details..."></textarea>

                    <div style="margin-top: 0.5rem; display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.75rem;">Next Follow Up Date</label>
                            <input type="date" id="followUpDate">
                        </div>

                    </div>
                </div>
            </div>

            <div class="divider" style="height: 1px; background: #e5e7eb; margin: 1rem 0 2rem 0;"></div>



            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="saveClaimChanges()">Save Changes</button>
            </div>
        </div>

        <div id="tab-workflow" class="tab-content">
            <div class="checkbox-list">
                <div id="wf-section-repair">
                    <h4>Repair Completed</h4>
                    <label class="custom-checkbox">
                        <input type="checkbox" id="chk_repair_feedback">
                        <span class="checkmark"></span>
                        Feedback Done
                    </label>
                    <div class="workflow-row">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="chk_complete_repair">
                            <span class="checkmark"></span>
                            <strong>Mark as Complete</strong>
                        </label>
                    </div>
                </div>

                <!-- Enhanced Replacement Workflow Section -->
                <div class="workflow-section" id="workflow-replacement-section">
                    <div class="workflow-header">
                        <div class="workflow-title">
                            <i class="ri-exchange-line"></i>
                            Replacement Workflow
                        </div>
                        <div class="workflow-progress">
                            <span class="progress-text" id="workflow-progress-text">0 of 6 completed</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="workflow-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="workflow-steps">
                        <!-- Step 1 -->
                        <div class="workflow-step" data-step-number="1"
                            onclick="toggleWorkflowStep(this, 'chk_repl_confirmation')">
                            <div class="step-icon" data-step="1"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Customer Confirmation</div>
                                </div>
                                <input type="checkbox" id="chk_repl_confirmation" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                        <!-- Step 2 -->
                        <div class="workflow-step" data-step-number="2"
                            onclick="toggleWorkflowStep(this, 'chk_repl_osg_approval')">
                            <div class="step-icon" data-step="2"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Onsitego Approval</div>
                                </div>
                                <input type="checkbox" id="chk_repl_osg_approval" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                        <!-- Step 3 -->
                        <div class="workflow-step" data-step-number="3"
                            onclick="toggleWorkflowStep(this, 'chk_repl_mail_store')">
                            <div class="step-icon" data-step="3"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Mail Sent To Store</div>
                                </div>
                                <input type="checkbox" id="chk_repl_mail_store" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                        <!-- Step 4 -->
                        <div class="workflow-step" data-step-number="4"
                            onclick="toggleWorkflowStep(this, 'chk_repl_invoice_gen')">
                            <div class="step-icon" data-step="4"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Invoice Generated</div>
                                </div>
                                <input type="checkbox" id="chk_repl_invoice_gen" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                        <!-- Step 5 -->
                        <div class="workflow-step" data-step-number="5"
                            onclick="toggleWorkflowStep(this, 'chk_repl_invoice_sent')">
                            <div class="step-icon" data-step="5"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Invoice Sent To Onsitego</div>
                                </div>
                                <input type="checkbox" id="chk_repl_invoice_sent" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                        <!-- Step 6 -->
                        <div class="workflow-step" data-step-number="6"
                            onclick="toggleWorkflowStep(this, 'chk_repl_settled_accounts')">
                            <div class="step-icon" data-step="6"></div>
                            <div class="step-content">
                                <div class="step-info">
                                    <div class="step-label">Settled with Accounts</div>
                                </div>
                                <input type="checkbox" id="chk_repl_settled_accounts" class="step-checkbox"
                                    onclick="event.stopPropagation(); updateWorkflowProgress()">
                            </div>
                        </div>
                    </div>

                    <div class="workflow-row" style="margin-top: 1rem;">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="chk_complete_repl">
                            <span class="checkmark"></span>
                            <strong>Mark as Complete</strong>
                        </label>
                    </div>

                </div>

            </div>

            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="saveClaimChanges()">Save Changes</button>
            </div>
        </div>

    </div>
</template>

<script>
    /**
     * Enhanced Workflow Functions
     */

    // Toggle workflow step by clicking anywhere on the row
    function toggleWorkflowStep(stepElement, checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            updateWorkflowProgress();

            // Update visual state
            if (checkbox.checked) {
                stepElement.classList.add('completed');
            } else {
                stepElement.classList.remove('completed');
            }
        }
    }

    // Update progress bar and counter
    function updateWorkflowProgress() {
        const checkboxes = [
            'chk_repl_confirmation',
            'chk_repl_osg_approval',
            'chk_repl_mail_store',
            'chk_repl_invoice_gen',
            'chk_repl_invoice_sent',
            'chk_repl_settled_accounts'
        ];

        let completed = 0;
        const total = checkboxes.length;

        checkboxes.forEach((id, index) => {
            const checkbox = document.getElementById(id);
            const stepElement = document.querySelector(`[data-step-number="${index + 1}"]`);

            if (checkbox && checkbox.checked) {
                completed++;
                if (stepElement) stepElement.classList.add('completed');
            } else {
                if (stepElement) stepElement.classList.remove('completed');
            }
        });

        // Update progress bar
        const percentage = (completed / total) * 100;
        const progressBar = document.getElementById('workflow-progress-bar');
        const progressText = document.getElementById('workflow-progress-text');

        if (progressBar) {
            progressBar.style.width = percentage + '%';
        }

        if (progressText) {
            progressText.textContent = `${completed} of ${total} completed`;
        }

        // Update completion badge
        const completionBadge = document.getElementById('workflow-completion-badge');
        const completionText = document.getElementById('completion-badge-text');

        if (completionBadge && completionText) {
            if (completed === total) {
                completionBadge.className = 'completion-badge complete';
                completionText.innerHTML = '<i class="ri-checkbox-circle-line"></i> All Steps Completed';

                // AUTO-CHECK "Mark as Complete" when all 6 steps are done
                const completeCheckbox = document.getElementById('chk_complete_repl');
                if (completeCheckbox && !completeCheckbox.checked) {
                    completeCheckbox.checked = true;
                    updateCompletionStatus();
                }
            } else {
                completionBadge.className = 'completion-badge incomplete';
                completionText.innerHTML = `<i class="ri-time-line"></i> ${total - completed} Steps Remaining`;
            }
        }
    }

    // Update completion status
    function updateCompletionStatus() {
        const completeCheckbox = document.getElementById('chk_complete_repl');
        const stepElement = completeCheckbox?.closest('.workflow-step');

        if (completeCheckbox && stepElement) {
            if (completeCheckbox.checked) {
                stepElement.classList.add('completed');
            } else {
                stepElement.classList.remove('completed');
            }
        }
    }

    // Save workflow changes with visual feedback
    async function saveWorkflowChanges() {
        const btn = document.getElementById('saveWorkflowBtn');
        const section = document.getElementById('workflow-replacement-section');

        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line"></i> Saving...';
        section.classList.add('loading');

        try {
            // Call the existing saveClaimChanges function
            await saveClaimChanges();

            // Success animation
            section.classList.add('save-success');
            btn.innerHTML = '<i class="ri-checkbox-circle-line"></i> Saved Successfully!';
            btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';

            setTimeout(() => {
                btn.innerHTML = '<i class="ri-save-line"></i> Save Changes';
                btn.style.background = '';
                section.classList.remove('save-success');
            }, 1500);

        } catch (error) {
            console.error('Error saving workflow:', error);
            btn.innerHTML = '<i class="ri-error-warning-line"></i> Save Failed - Try Again';
            btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';

            setTimeout(() => {
                btn.innerHTML = '<i class="ri-save-line"></i> Save Changes';
                btn.style.background = '';
            }, 2000);

        } finally {
            btn.disabled = false;
            section.classList.remove('loading');
        }
    }

    // Initialize workflow when modal opens - integrate with existing openClaimModal
    window.initializeWorkflow = function (claim) {
        // Set checkbox states
        if (document.getElementById('chk_repl_confirmation')) {
            document.getElementById('chk_repl_confirmation').checked = claim.replacement_confirmation || false;
        }
        if (document.getElementById('chk_repl_osg_approval')) {
            document.getElementById('chk_repl_osg_approval').checked = claim.replacement_osg_approval || false;
        }
        if (document.getElementById('chk_repl_mail_store')) {
            document.getElementById('chk_repl_mail_store').checked = claim.replacement_mail_store || false;
        }
        if (document.getElementById('chk_repl_invoice_gen')) {
            document.getElementById('chk_repl_invoice_gen').checked = claim.replacement_invoice_gen || false;
        }
        if (document.getElementById('chk_repl_invoice_sent')) {
            document.getElementById('chk_repl_invoice_sent').checked = claim.replacement_invoice_sent || false;
        }
        if (document.getElementById('chk_repl_settled_accounts')) {
            document.getElementById('chk_repl_settled_accounts').checked = claim.replacement_settled_accounts || false;
        }
        if (document.getElementById('chk_complete_repl')) {
            document.getElementById('chk_complete_repl').checked = claim.complete || false;
        }

        // Update TAT
        if (claim.tat !== null && claim.tat !== undefined) {
            const tatElement = document.getElementById('disp_tat');
            if (tatElement) {
                tatElement.textContent = claim.tat;
            }
        }

        // Update progress
        updateWorkflowProgress();
        updateCompletionStatus();
    };
</script>

{% endblock %}