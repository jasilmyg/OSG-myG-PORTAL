{% extends "layout.html" %}

{% block content %}
<!-- Analytics Dashboard -->
<div class="analytics-container">
    <!-- Page Header -->
    <div class="analytics-header">
        <div class="header-content">
            <h1><i class="ri-dashboard-3-line"></i> Analytics Dashboard</h1>
            <p>Comprehensive insights and performance metrics</p>
        </div>
        <div class="header-actions">
            <button class="btn-refresh" onclick="refreshDashboard()">
                <i class="ri-refresh-line"></i> Refresh Data
            </button>
        </div>
    </div>

    <!-- ðŸ”¹ 1. FILTER SECTION -->
    <div class="filter-section glass-panel">
        <div class="filter-header">
            <h3><i class="ri-filter-3-line"></i> Filters</h3>
        </div>

        <div class="filter-grid">
            <!-- Date Range -->
            <div class="filter-group">
                <label><i class="ri-calendar-line"></i> Date Range</label>
                <div class="date-range-inputs">
                    <input type="date" id="filterDateFrom" class="filter-input">
                    <span class="date-separator">to</span>
                    <input type="date" id="filterDateTo" class="filter-input">
                </div>
            </div>

            <!-- Status Filter -->
            <div class="filter-group">
                <label><i class="ri-flag-line"></i> Status</label>
                <select id="filterStatus" class="filter-input">
                    <option value="">All Statuses</option>
                    <option value="Submitted">Submitted</option>
                    <option value="Registered">Registered</option>
                    <option value="Follow Up">Follow Up</option>
                    <option value="Repair Completed">Repair Completed</option>
                    <option value="Replacement approved">Replacement Approved</option>
                    <option value="Settled">Settled</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>

            <!-- Replacement Stage -->
            <div class="filter-group">
                <label><i class="ri-exchange-line"></i> Replacement Stage</label>
                <select id="filterReplacementStage" class="filter-input">
                    <option value="">All Stages</option>
                    <option value="replacement_confirmation">Confirmation Pending</option>
                    <option value="replacement_osg_approval">OSG Approval</option>
                    <option value="replacement_mail_store">Mail to Store</option>
                    <option value="replacement_invoice_gen">Invoice Generated</option>
                    <option value="replacement_invoice_sent">Invoice Sent to OSG</option>
                    <option value="replacement_settled_accounts">Settled with Accounts</option>
                </select>
            </div>

            <!-- Complete Filter -->
            <div class="filter-group">
                <label><i class="ri-checkbox-circle-line"></i> Completion</label>
                <select id="filterComplete" class="filter-input">
                    <option value="">All</option>
                    <option value="true">Complete</option>
                    <option value="false">Incomplete</option>
                </select>
            </div>

            <!-- Claim ID Search -->
            <div class="filter-group">
                <label><i class="ri-search-line"></i> Claim ID</label>
                <input type="text" id="filterClaimId" class="filter-input" placeholder="Enter Claim ID...">
            </div>

            <!-- Mobile Number Search -->
            <div class="filter-group">
                <label><i class="ri-phone-line"></i> Mobile Number</label>
                <input type="text" id="filterMobile" class="filter-input" placeholder="Enter Mobile...">
            </div>
        </div>

        <!-- Filter Action Buttons -->
        <div class="filter-actions">
            <button class="btn-apply-filters" onclick="applyFilters()">
                <i class="ri-filter-line"></i> Apply Filters
            </button>
            <button class="btn-clear-filters" onclick="clearAllFilters()">
                <i class="ri-close-circle-line"></i> Clear All
            </button>
        </div>
    </div>

    <!-- ðŸ”¹ 2. KPI CARDS -->
    <div class="kpi-section">
        <div class="kpi-card glass-panel blue">
            <div class="kpi-icon">
                <i class="ri-file-list-3-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Total Claims</h4>
                <div class="kpi-value" id="kpi-total">0</div>
                <p class="kpi-subtitle">All time</p>
            </div>
        </div>

        <div class="kpi-card glass-panel orange">
            <div class="kpi-icon">
                <i class="ri-folder-open-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Open Claims</h4>
                <div class="kpi-value" id="kpi-open">0</div>
                <p class="kpi-subtitle">Pending resolution</p>
            </div>
        </div>

        <div class="kpi-card glass-panel purple">
            <div class="kpi-icon">
                <i class="ri-exchange-box-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Replacement Pending</h4>
                <div class="kpi-value" id="kpi-replacement">0</div>
                <p class="kpi-subtitle">In workflow</p>
            </div>
        </div>

        <div class="kpi-card glass-panel indigo">
            <div class="kpi-icon">
                <i class="ri-tools-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Repair Completed</h4>
                <div class="kpi-value" id="kpi-repair-completed">0</div>
                <p class="kpi-subtitle">Repaired</p>
            </div>
        </div>

        <div class="kpi-card glass-panel green">
            <div class="kpi-icon">
                <i class="ri-checkbox-circle-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Replacement Approved Completed</h4>
                <div class="kpi-value" id="kpi-settled">0</div>
                <p class="kpi-subtitle">Completed</p>
            </div>
        </div>



        <div class="kpi-card glass-panel indigo">
            <div class="kpi-icon">
                <i class="ri-calendar-event-line"></i>
            </div>
            <div class="kpi-content">
                <h4>Today's New</h4>
                <div class="kpi-value" id="kpi-today">0</div>
                <p class="kpi-subtitle">Submitted today</p>
            </div>
        </div>

        <div class="kpi-card glass-panel pink">
            <div class="kpi-icon">
                <i class="ri-calendar-check-line"></i>
            </div>
            <div class="kpi-content">
                <h4>This Month</h4>
                <div class="kpi-value" id="kpi-month">0</div>
                <p class="kpi-subtitle">Monthly total</p>
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ 3 & 4. CHARTS ROW -->
    <div class="charts-row">
        <!-- Status Distribution Chart -->
        <div class="chart-container glass-panel">
            <div class="chart-header">
                <h3><i class="ri-pie-chart-line"></i> Status Distribution</h3>
            </div>
            <div class="chart-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Replacement Workflow Funnel -->
        <div class="chart-container glass-panel">
            <div class="chart-header">
                <h3><i class="ri-flow-chart"></i> Replacement Workflow Progress</h3>
            </div>
            <div class="funnel-chart" id="replacementFunnel">
                <!-- Dynamic funnel steps will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ 5 & 6. TRENDS & MODELS ROW (New Analysis Section) -->
    <div class="charts-row">
        <!-- Claims Trend Chart -->
        <div class="chart-container glass-panel">
            <div class="chart-header">
                <h3><i class="ri-line-chart-line"></i> Claims Trend (Last 30 Days)</h3>
            </div>
            <div class="chart-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Top Models Chart -->
        <div class="chart-container glass-panel">
            <div class="chart-header">
                <h3><i class="ri-smartphone-line"></i> Top 5 Defective Models</h3>
            </div>
            <div class="chart-body">
                <canvas id="modelChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ 7. BRANCH ANALYSIS ROW -->
    <div class="charts-row">
        <!-- Branch Claims Chart -->
        <div class="chart-container glass-panel" style="width: 100%;">
            <div class="chart-header">
                <h3><i class="ri-store-2-line"></i> Branch Wise Analysis</h3>
            </div>
            <div class="chart-body" style="height: 300px;">
                <canvas id="branchChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ 5 & 6. LISTS ROW -->
    <div class="lists-row">
        <!-- Recent Claims -->
        <div class="list-container glass-panel">
            <div class="list-header">
                <h3><i class="ri-history-line"></i> Recent Claims</h3>
                <span class="badge">Last 10</span>
            </div>
            <div class="claims-list" id="recentClaimsList">
                <!-- Dynamic claims will be inserted here -->
            </div>
        </div>

        <!-- Pending Actions -->
        <div class="list-container glass-panel">
            <div class="list-header">
                <h3><i class="ri-alert-line"></i> Pending Actions</h3>
                <span class="badge" id="pendingActionsBadge">0</span>
            </div>

            <!-- Pending Follow-up -->
            <div class="action-section">
                <h4><i class="ri-phone-line"></i> Pending Follow-Up <span class="count"
                        id="pendingFollowUpCount">0</span></h4>
                <div class="action-list" id="pendingFollowUpList">
                    <!-- Dynamic items -->
                </div>
            </div>

            <!-- Pending Replacement -->
            <div class="action-section">
                <h4><i class="ri-exchange-line"></i> Pending Replacement <span class="count"
                        id="pendingReplacementCount">0</span></h4>
                <div class="action-list" id="pendingReplacementList">
                    <!-- Dynamic items -->
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ 7. FULL CLAIMS TABLE -->
    <div class="table-section glass-panel">
        <div class="table-header">
            <h3><i class="ri-table-line"></i> All Claims</h3>
            <div class="table-actions">
                <button class="btn-export" onclick="exportTableData()">
                    <i class="ri-download-line"></i> Export
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="analytics-table" id="claimsAnalyticsTable">
                <thead>
                    <tr>
                        <th>Claim ID</th>
                        <th>Submitted</th>
                        <th>Customer</th>
                        <th>Mobile</th>
                        <th>Product</th>
                        <th>Issue</th>
                        <th>Status</th>
                        <th>Replacement Progress</th>
                        <th>Complete</th>
                    </tr>
                </thead>
                <tbody id="claimsTableBody">
                    <!-- Dynamic rows -->
                </tbody>
            </table>
        </div>

        <div class="table-footer">
            <div class="showing-count">
                Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> claims
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Claim Details Modal -->
<div id="analytics-modal" class="modal-overlay hidden">
    <div class="modal-content glass-panel" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 id="modal-title">Claim Details</h2>
            <button class="btn-icon" onclick="closeAnalyticsModal()">
                <i class="ri-close-line"></i>
            </button>
        </div>

        <div class="modal-body" id="modal-body">
            <!-- Content populated by JS -->
            <div class="info-grid"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 2rem;">
                <div class="info-group">
                    <label>Claim ID</label>
                    <div id="m_claim_id" class="info-value">--</div>
                </div>
                <div class="info-group">
                    <label>Status</label>
                    <div id="m_status" class="info-value">--</div>
                </div>

                <div class="info-group">
                    <label>Customer Name</label>
                    <div id="m_customer" class="info-value">--</div>
                </div>
                <div class="info-group">
                    <label>Mobile Number</label>
                    <div id="m_mobile" class="info-value">--</div>
                </div>

                <div class="info-group">
                    <label>Product</label>
                    <div id="m_product" class="info-value">--</div>
                </div>
                <div class="info-group">
                    <label>Submitted Date</label>
                    <div id="m_date" class="info-value">--</div>
                </div>
            </div>

            <div class="full-width-group" style="margin-bottom: 2rem;">
                <label>Issue Description</label>
                <div id="m_issue" class="info-value"
                    style="background: rgba(0,0,0,0.03); padding: 1rem; border-radius: 8px;">--</div>
            </div>

            <div class="workflow-status-section" style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1rem;">
                <h3>Workflow Status</h3>
                <div id="m_workflow_steps" class="steps-list" style="margin-top: 1rem;">
                    <!-- Workflow steps populated here -->
                </div>
            </div>
        </div>

        <div class="modal-footer" style="margin-top: 2rem; display: flex; justify-content: flex-end;">
            <button class="btn-secondary" onclick="closeAnalyticsModal()">Close</button>
        </div>
    </div>
</div>

<style>
    .info-group label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .step-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
    }

    .step-icon {
        margin-right: 12px;
        font-size: 1.2rem;
    }

    .step-label {
        flex: 1;
    }
</style>

<!-- Analytics Script -->
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>

{% endblock %}